# 🚀 Chapter 1: 架构思想与项目设计

本项目是一个基于**整洁架构 (Clean Architecture)** 和 **领域驱动设计 (DDD)** 构建的 Go API 服务模板。

## 1. 核心架构思想

### 1.1 整洁架构 (Clean Architecture)

整洁架构的核心目标是**关注点分离**，将系统划分为多个同心圆层级，每一层只依赖其内层。

```
┌───────────────────────────────────────────────────────────────┐
│                         Frameworks                            │  最外层：框架与驱动
│            (Gin, gRPC, MySQL Driver, Redis Client)            │
├───────────────────────────────────────────────────────────────┤
│                      Interface Adapters                       │  适配器层
│              (Controllers, Gateways, Presenters)              │
├───────────────────────────────────────────────────────────────┤
│                      Application Layer                        │  应用层
│             (Use Cases, Application Services)                 │
├───────────────────────────────────────────────────────────────┤
│                         Domain Layer                          │  核心层：领域实体
│         (Entities, Business Rules, Repository Interfaces)     │
└───────────────────────────────────────────────────────────────┘
```

**依赖规则**：所有依赖方向必须指向内层。外层代码可以引用内层，内层代码绝不能引用外层。

### 1.2 领域驱动设计 (DDD)

DDD 强调以**业务领域**为中心进行软件设计，而非以技术实现为中心。

| 概念                        | 说明                                           |
| --------------------------- | ---------------------------------------------- |
| **Entity (实体)**     | 具有唯一标识的业务对象，如 User、Order         |
| **Repository (仓储)** | 数据访问的抽象接口，定义在领域层，实现在数据层 |
| **Use Case (用例)**   | 一个完整的业务操作流程，如"创建订单"           |

### 1.3 依赖倒置原则 (DIP)

传统分层架构中，高层依赖低层（业务层依赖数据层）。依赖倒置则相反：

- **领域层定义接口**：`type UserRepo interface { GetByID(...) }`
- **数据层实现接口**：`type userRepo struct { db *gorm.DB }`
- **运行时注入**：通过依赖注入将实现传入领域层

这使得领域层完全不知道数据存储在哪里（MySQL、MongoDB、还是内存），保持了业务逻辑的纯净。

## 2. 设计选型

本项目采用的技术栈遵循"编译期安全"和"Schema First"原则。

### 2.1 Schema First：定义优先

传统开发流程是先写代码再补文档。本项目采用相反的方式：

1. 先编写 `.proto` 文件定义 API 接口、请求体、响应体
2. 使用工具自动生成 Go 结构体、gRPC 服务代码、HTTP 路由
3. 开发者只需填充业务逻辑

工具选型：**Buf** (protoc 的现代替代品，解决了依赖管理和生成速度问题)

### 2.2 编译期依赖注入

运行时依赖注入框架（如 Java Spring）依赖反射，错误只能在运行时发现。

本项目选用 **Google Wire**：

- 编译期生成初始化代码
- 依赖关系错误在编译时就能发现
- 零运行时开销

### 2.3 技术选型表

| 领域      | 选型           | 选择理由                       |
| --------- | -------------- | ------------------------------ |
| HTTP 框架 | Gin            | 性能优异，生态成熟，社区活跃   |
| RPC 框架  | gRPC           | Google 标准，强类型，高性能    |
| API 定义  | Protobuf + Buf | Schema First，自动生成代码     |
| 依赖注入  | Google Wire    | 编译期 DI，类型安全            |
| ORM       | Ent (推荐)     | 基于 Schema 生成代码，类型安全 |

## 3. 目录结构

```
go-api-template/
├── api/                      # API 定义层
│   ├── helloworld/v1/        # 模块/版本
│   │   └── greeter.proto     # Protobuf 定义
│   └── buf.yaml              # Buf 模块配置
├── buf.gen.yaml              # Buf 代码生成配置
├── cmd/
│   └── server/               # 程序入口
│       ├── main.go           # 启动入口
│       ├── wire.go           # 依赖注入声明
│       └── wire_gen.go       # 自动生成的注入代码
├── configs/                  # 配置文件
├── internal/                 # 核心业务代码（私有）
│   ├── biz/                  # 领域层
│   ├── data/                 # 数据层
│   ├── service/              # 应用层
│   └── server/               # 传输层
├── ent/                      # Ent ORM 生成代码
├── third_party/              # 第三方 proto 文件
├── docs/                     # 项目文档
├── Makefile                  # 构建命令
├── go.mod
└── go.sum
```

## 4. 各目录职责详解

### 4.1 api/ - API 定义层

存放所有 Protobuf 定义文件。这是整个系统的"契约"。

- 不包含任何 Go 代码（生成的代码会放在同目录或指定位置）
- 使用 `buf` 管理依赖和生成
- 版本化目录结构：`api/{模块}/v1/`

### 4.2 cmd/server/ - 程序入口

应用程序的启动点。职责单一：

- 加载配置
- 初始化依赖（通过 Wire）
- 启动 HTTP/gRPC 服务器
- 处理优雅关闭

### 4.3 internal/ - 核心业务代码

Go 的 `internal` 目录具有特殊语义：其内部代码无法被外部包导入。这确保了业务代码的私有性。

#### 4.3.1 internal/biz/ - 领域层（核心）

这是整洁架构的**圆心**，包含：

| 内容            | 说明                                |
| --------------- | ----------------------------------- |
| 领域实体        | 核心业务对象 (User, Order, Product) |
| 业务规则        | 纯业务逻辑，与框架无关              |
| Repository 接口 | 数据访问的抽象定义                  |

**依赖规则**：此层不依赖任何外层。不允许导入 Gin、GORM、数据库驱动等。

#### 4.3.2 internal/data/ - 数据层

实现 `biz` 层定义的 Repository 接口。

| 内容            | 说明                         |
| --------------- | ---------------------------- |
| Repository 实现 | 实现 `biz.UserRepo` 等接口 |
| 数据库连接      | 管理 DB、Redis 连接池        |
| 外部 API 调用   | 封装第三方服务调用           |

**依赖规则**：此层依赖 `biz` 层（实现其接口），允许导入数据库驱动。

#### 4.3.3 internal/service/ - 应用层

实现 `api` 层定义的服务接口，编排业务逻辑。

| 内容     | 说明                            |
| -------- | ------------------------------- |
| API 实现 | 实现 proto 定义的服务接口       |
| DTO 转换 | API 请求/响应与领域对象的转换   |
| 业务编排 | 调用多个 biz 层用例完成复杂操作 |

**依赖规则**：此层依赖 `biz` 层和 `api` 层。

#### 4.3.4 internal/server/ - 传输层

配置和启动 HTTP/gRPC 服务器。

| 内容        | 说明                     |
| ----------- | ------------------------ |
| HTTP Server | Gin 路由配置、中间件     |
| gRPC Server | gRPC 服务注册            |
| 中间件      | 日志、认证、限流、跨域等 |

**依赖规则**：此层依赖 `service` 层，将服务注册到具体协议。

### 4.4 ent/ - ORM 生成代码

如果选用 Ent 作为 ORM，此目录存放根据 Schema 自动生成的代码。

### 4.5 configs/ - 配置文件

存放 YAML/JSON 配置文件模板。实际部署时通过环境变量或配置中心覆盖。

### 4.6 third_party/ - 第三方 Proto

存放非本项目定义的 proto 文件，如 Google 的 `annotations.proto`。

## 5. 依赖流向图

```
┌─────────────┐
│   cmd/      │  入口：初始化所有依赖，启动服务
└──────┬──────┘
       │ 依赖
       ▼
┌─────────────┐
│   server/   │  传输层：配置 HTTP/gRPC
└──────┬──────┘
       │ 依赖
       ▼
┌─────────────┐
│  service/   │  应用层：实现 API，编排业务
└──────┬──────┘
       │ 依赖
       ▼
┌─────────────┐      ┌─────────────┐
│    biz/     │◄─────│    data/    │
│  (领域层)    │ 实现 │  (数据层)    |
│  定义接口    │ 接口 │  实现接口    │
└─────────────┘      └─────────────┘
       ▲
       │ 核心
       │ 不依赖任何外层
```

**关键理解**：`biz` 层定义 `UserRepo` 接口，`data` 层实现该接口。`biz` 层不知道也不关心数据存在 MySQL 还是 MongoDB，这就是依赖倒置的魅力。
